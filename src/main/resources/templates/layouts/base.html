<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content)" th:lang="${#locale.language}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${#messages.msgOrNull(pageTitle)} ?: #{app.title}">Finanzapp</title>
    <script>
      (() => {
        try {
          const storedTheme = window.localStorage.getItem("finanzapp.theme");
          if (storedTheme === "light" || storedTheme === "dark") {
            document.documentElement.dataset.theme = storedTheme;
          }
        } catch (error) {
        }
      })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/app.css}" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </head>
  <body>
    <div class="app-shell" id="app-shell">
      <aside class="sidebar" id="app-sidebar">
        <div class="brand" th:text="#{app.title}">Finanzapp</div>
        <nav class="nav" th:with="currentPage=${pageTitle} ?: ''">
          <a
              th:href="@{/overview}"
              th:classappend="${currentPage == 'page.overview'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.overview'} ? 'page' : null"
              th:text="#{nav.overview}">Overview</a>
          <a
              th:href="@{/transactions}"
              th:classappend="${currentPage == 'page.transactions'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.transactions'} ? 'page' : null"
              th:text="#{nav.transactions}">Expenses</a>
          <a
              th:href="@{/rules}"
              th:classappend="${currentPage == 'page.rules'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.rules'} ? 'page' : null"
              th:text="#{nav.rules}">Rules</a>
          <a
              th:href="@{/categories}"
              th:classappend="${currentPage == 'page.categories'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.categories'} ? 'page' : null"
              th:text="#{nav.categories}">Categories</a>
          <a href="#" th:text="#{nav.budgets}">Budgets</a>
          <a href="#" th:text="#{nav.investments}">Investments</a>
          <a
              th:href="@{/reports/sankey}"
              th:classappend="${currentPage == 'page.sankey'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.sankey'} ? 'page' : null"
              th:text="#{nav.reports}">Reports</a>
          <a
              th:href="@{/settings}"
              th:classappend="${currentPage == 'page.settings'} ? ' is-active'"
              th:attr="aria-current=${currentPage == 'page.settings'} ? 'page' : null"
              th:text="#{nav.settings}">Settings</a>
        </nav>
      </aside>
      <main class="content">
        <header class="page-header">
          <div class="page-header-leading">
            <button
                type="button"
                class="nav-toggle"
                id="nav-toggle"
                aria-controls="app-sidebar"
                aria-expanded="true"
                th:attr="data-label-expand=#{nav.expand},data-label-collapse=#{nav.collapse}">
              <span class="nav-toggle-icon" aria-hidden="true"></span>
              <span class="nav-toggle-label" th:text="#{nav.collapse}">Hide navigation</span>
            </button>
            <h1 th:text="${#messages.msgOrNull(pageTitle)} ?: ${pageTitle}">Page</h1>
          </div>
          <div class="page-header-actions">
            <button
                type="button"
                class="theme-toggle"
                id="theme-toggle"
                aria-pressed="false"
                th:attr="data-label-light=#{theme.switchToLight},data-label-dark=#{theme.switchToDark}">
              <span class="theme-toggle-icon" aria-hidden="true"></span>
              <span class="theme-toggle-label" th:text="#{theme.switchToDark}">Switch to dark mode</span>
            </button>
            <form class="logout" th:action="@{/logout}" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <button type="submit" th:text="#{nav.logout}">Log out</button>
            </form>
          </div>
        </header>
        <section class="page-body" th:replace="${content}"></section>
      </main>
    </div>
    <script>
      (() => {
        const appShell = document.getElementById("app-shell");
        const sidebar = document.getElementById("app-sidebar");
        const toggle = document.getElementById("nav-toggle");
        const themeToggle = document.getElementById("theme-toggle");
        if (!appShell || !sidebar || !toggle) {
          return;
        }

        const labelNode = toggle.querySelector(".nav-toggle-label");
        const labelExpand = toggle.dataset.labelExpand || "Show navigation";
        const labelCollapse = toggle.dataset.labelCollapse || "Hide navigation";
        const mobileQuery = window.matchMedia("(max-width: 900px)");
        const storageKey = "finanzapp.navCollapsed";

        const themeStorageKey = "finanzapp.theme";
        const themeLabelNode = themeToggle ? themeToggle.querySelector(".theme-toggle-label") : null;
        const darkLabel = themeToggle ? themeToggle.dataset.labelDark || "Switch to dark mode" : "Switch to dark mode";
        const lightLabel = themeToggle ? themeToggle.dataset.labelLight || "Switch to light mode" : "Switch to light mode";

        const getStoredTheme = () => {
          try {
            const storedTheme = window.localStorage.getItem(themeStorageKey);
            if (storedTheme === "light" || storedTheme === "dark") {
              return storedTheme;
            }
          } catch (error) {
          }
          return null;
        };

        const detectTheme = () => {
          const storedTheme = getStoredTheme();
          if (storedTheme) {
            return storedTheme;
          }
          return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        };

        const applyTheme = (theme, persist) => {
          const resolvedTheme = theme === "dark" ? "dark" : "light";
          document.documentElement.dataset.theme = resolvedTheme;
          if (themeToggle) {
            const isDark = resolvedTheme === "dark";
            themeToggle.setAttribute("aria-pressed", String(isDark));
            const buttonLabel = isDark ? lightLabel : darkLabel;
            themeToggle.setAttribute("aria-label", buttonLabel);
            if (themeLabelNode) {
              themeLabelNode.textContent = buttonLabel;
            }
          }
          if (persist) {
            try {
              window.localStorage.setItem(themeStorageKey, resolvedTheme);
            } catch (error) {
            }
          }
        };

        applyTheme(detectTheme(), false);

        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const currentTheme = document.documentElement.dataset.theme === "dark" ? "dark" : "light";
            applyTheme(currentTheme === "dark" ? "light" : "dark", true);
          });
        }

        const readStoredDesktopState = () => {
          try {
            return window.localStorage.getItem(storageKey) === "true";
          } catch (error) {
            return false;
          }
        };

        const writeStoredDesktopState = (collapsed) => {
          try {
            window.localStorage.setItem(storageKey, String(collapsed));
          } catch (error) {
          }
        };

        const applyState = (collapsed, persistDesktop) => {
          const isMobile = mobileQuery.matches;
          if (isMobile) {
            appShell.classList.toggle("is-nav-open", !collapsed);
            appShell.classList.remove("is-nav-collapsed");
          } else {
            appShell.classList.remove("is-nav-open");
            appShell.classList.toggle("is-nav-collapsed", collapsed);
          }

          sidebar.setAttribute("aria-hidden", String(collapsed));
          toggle.setAttribute("aria-expanded", String(!collapsed));
          const label = collapsed ? labelExpand : labelCollapse;
          toggle.setAttribute("aria-label", label);
          if (labelNode) {
            labelNode.textContent = label;
          }

          if (persistDesktop && !isMobile) {
            writeStoredDesktopState(collapsed);
          }
        };

        const applyInitialState = () => {
          if (mobileQuery.matches) {
            applyState(true, false);
            return;
          }
          applyState(readStoredDesktopState(), false);
        };

        applyInitialState();

        toggle.addEventListener("click", () => {
          const collapsed = !toggle.getAttribute("aria-expanded") || toggle.getAttribute("aria-expanded") === "true";
          applyState(collapsed, true);
        });

        sidebar.addEventListener("click", (event) => {
          if (!mobileQuery.matches) {
            return;
          }
          const link = event.target.closest("a[href]");
          if (link) {
            applyState(true, false);
          }
        });

        mobileQuery.addEventListener("change", () => {
          applyInitialState();
        });

        const systemThemeQuery = window.matchMedia("(prefers-color-scheme: dark)");
        systemThemeQuery.addEventListener("change", () => {
          if (!getStoredTheme()) {
            applyTheme(systemThemeQuery.matches ? "dark" : "light", false);
          }
        });
      })();
    </script>
  </body>
</html>
