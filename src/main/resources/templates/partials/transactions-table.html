<div id="transactions-table" th:fragment="container">
  <div class="notice notice-error" th:if="${partialError == true}">
    <span th:text="${partialErrorMessage}">Loading failed.</span>
    <button
      type="button"
      th:attr="hx-get=${partialRetryPath}"
      hx-trigger="click"
      hx-target="closest #transactions-table"
      hx-swap="outerHTML"
      th:text="#{partial.retry}">Retry</button>
  </div>

  <table class="data-table" th:if="${partialError != true}">
    <thead>
      <tr>
        <th th:text="#{table.name}">Name</th>
        <th th:text="#{table.date}">Date</th>
        <th th:text="#{table.amount}">Amount</th>
        <th th:text="#{table.category}">Category</th>
        <th th:text="#{table.actions}">Actions</th>
      </tr>
    </thead>
    <tbody th:if="${transactionsEmpty}">
      <tr>
        <td colspan="5" class="empty-state" th:text="#{transactions.empty}">No transactions to show.</td>
      </tr>
    </tbody>
    <tbody th:if="${!transactionsEmpty}">
      <tr th:each="transaction : ${transactions}">
        <td>
          <div th:text="${transaction.name}">Name</div>
          <div class="subtle" th:text="${transaction.purpose}">Verwendungszweck</div>
        </td>
        <td th:text="${transaction.date}">2026-02-01</td>
        <td th:text="${transaction.amount}">-31.00 EUR</td>
        <td class="category-cell">
          <div class="category-main">
            <span
              class="category-chip"
              th:classappend="${transaction.defaultCategory} ? ' category-chip-default' : (${transaction.assignedBy} == 'MANUAL' ? ' category-chip-manual' : ' category-chip-rule')"
              th:text="${transaction.categoryLabel} ?: #{transactions.category.none}">Sonstiges -> Unkategorisiert</span>
            <span
              class="category-warning"
              th:if="${transaction.conflictNames}"
              th:title="#{transactions.category.conflicts(${transaction.conflictNames})}">!</span>
          </div>

          <form
            class="category-form"
            th:action="@{'/transactions/' + ${transaction.id} + '/set-category'}"
            method="post"
            th:attr="hx-post=@{'/transactions/' + ${transaction.id} + '/set-category'}"
            hx-target="#transactions-table"
            hx-swap="outerHTML">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="minAmount" th:value="${minAmount}" />
            <input type="hidden" name="maxAmount" th:value="${maxAmount}" />
            <input type="hidden" name="nameContains" th:value="${nameContains}" />
            <input type="hidden" name="purposeContains" th:value="${purposeContains}" />
            <input type="hidden" name="onlyUncategorized" th:value="${onlyUncategorized}" />
            <input type="hidden" name="page" th:value="${currentPage}" />
            <select name="categoryId" required>
              <option
                th:each="option : ${categoryOptions}"
                th:value="${option.id}"
                th:selected="${option.id == transaction.categoryId}"
                th:text="${option.label}">Sonstiges -> Unkategorisiert</option>
            </select>
            <button type="submit" th:text="#{transactions.category.save}">Save</button>
          </form>
        </td>
        <td>
          <form
              th:action="@{'/transactions/' + ${transaction.id} + '/delete'}"
              method="post"
              onsubmit="return confirm(this.dataset.confirm);"
              th:attr="data-confirm=#{confirm.deleteTransaction}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" th:text="#{transactions.delete}">Delete</button>
          </form>
        </td>
      </tr>
    </tbody>
  </table>
  <div class="table-pagination" th:if="${partialError != true and totalPages > 1}">
    <form class="pagination-form" method="get" th:action="@{/transactions}" th:hx-get="@{/partials/transactions-table}" hx-target="#transactions-table" hx-swap="outerHTML">
      <input type="hidden" name="nameContains" th:value="${nameContains}" />
      <input type="hidden" name="purposeContains" th:value="${purposeContains}" />
      <input type="hidden" name="onlyUncategorized" th:value="${onlyUncategorized}" />
      <input type="hidden" name="minAmount" th:value="${minAmount}" />
      <input type="hidden" name="maxAmount" th:value="${maxAmount}" />
      <input type="hidden" name="page" th:value="${previousPage}" />
      <button type="submit" th:disabled="${!hasPreviousPage}" th:text="#{transactions.previous}">Previous</button>
    </form>

    <span class="pagination-label" th:text="#{transactions.pageLabel(${currentPage + 1}, ${totalPages})}">Page 1 of 1</span>

    <form class="pagination-form" method="get" th:action="@{/transactions}" th:hx-get="@{/partials/transactions-table}" hx-target="#transactions-table" hx-swap="outerHTML">
      <input type="hidden" name="nameContains" th:value="${nameContains}" />
      <input type="hidden" name="purposeContains" th:value="${purposeContains}" />
      <input type="hidden" name="onlyUncategorized" th:value="${onlyUncategorized}" />
      <input type="hidden" name="minAmount" th:value="${minAmount}" />
      <input type="hidden" name="maxAmount" th:value="${maxAmount}" />
      <input type="hidden" name="page" th:value="${nextPage}" />
      <button type="submit" th:disabled="${!hasNextPage}" th:text="#{transactions.next}">Next</button>
    </form>
  </div>
</div>
