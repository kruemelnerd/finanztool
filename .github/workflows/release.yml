name: Release

on:
  workflow_run:
    workflows:
      - Build
    types:
      - completed

permissions:
  actions: read
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    name: Build and publish release
    if: ${{ github.event.workflow_run.event == 'push' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.head_repository.full_name == github.repository && github.event.workflow_run.head_repository.fork == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          RELEASE_DIR="$RUNNER_TEMP/release-assets"
          mkdir -p "$RELEASE_DIR"

          gh run download "${{ github.event.workflow_run.id }}" \
            --repo "${{ github.repository }}" \
            --name "release-assets-${{ github.event.workflow_run.head_sha }}" \
            --dir "$RELEASE_DIR"

      - name: Prepare release metadata
        id: meta
        shell: bash
        run: |
          RELEASE_DIR="$RUNNER_TEMP/release-assets"

          shopt -s nullglob globstar

          VERSION_FILE=""
          for candidate in "$RELEASE_DIR"/**/version.txt; do
            VERSION_FILE="$candidate"
            break
          done

          SHORT_SHA_FILE=""
          for candidate in "$RELEASE_DIR"/**/short_sha.txt; do
            SHORT_SHA_FILE="$candidate"
            break
          done

          if [ -z "$VERSION_FILE" ] || [ -z "$SHORT_SHA_FILE" ]; then
            echo "Release metadata files are missing."
            exit 1
          fi

          VERSION="$(tr -d '\n' < "$VERSION_FILE")"
          SHORT_SHA="$(tr -d '\n' < "$SHORT_SHA_FILE")"
          TAG="release-${VERSION}-${SHORT_SHA}"

          JAR_PATH=""
          for candidate in "$RELEASE_DIR"/**/*.jar; do
            case "$candidate" in
              *original-*)
                continue
                ;;
              *)
                JAR_PATH="$candidate"
                break
                ;;
            esac
          done

          if [ -z "$JAR_PATH" ]; then
            echo "No release jar found in downloaded release assets."
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.event.workflow_run.head_sha }}
          generate_release_notes: true
          files: |
            ${{ steps.meta.outputs.jar_path }}
