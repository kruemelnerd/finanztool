name: Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 21
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9
        with:
          java-version: 21
          distribution: temurin
      - name: Cache SonarQube packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=kruemelnerd_finanztool

      - name: Prepare release assets
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: release_assets
        shell: bash
        run: |
          RELEASE_DIR="$RUNNER_TEMP/release-assets"
          mkdir -p "$RELEASE_DIR"

          shopt -s nullglob
          JAR_PATH=""
          for candidate in target/*.jar; do
            case "$candidate" in
              *original-*)
                continue
                ;;
              *)
                JAR_PATH="$candidate"
                break
                ;;
            esac
          done

          if [ -z "$JAR_PATH" ]; then
            echo "No release jar found in target/."
            exit 1
          fi

          cp "$JAR_PATH" "$RELEASE_DIR/"

          VERSION="$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)"
          printf '%s\n' "$VERSION" > "$RELEASE_DIR/version.txt"
          printf '%s\n' "${GITHUB_SHA::7}" > "$RELEASE_DIR/short_sha.txt"

          echo "artifact_name=release-assets-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "artifact_path=$RELEASE_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ steps.release_assets.outputs.artifact_name }}
          path: ${{ steps.release_assets.outputs.artifact_path }}
          if-no-files-found: error

  dependabot-version-bump:
    name: Dependabot Version Bump
    needs: build
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    concurrency:
      group: dependabot-version-bump-main
      cancel-in-progress: false
    steps:
      - name: Check whether commit is merged Dependabot PR
        id: gate
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
          HEAD_SHA: ${{ github.sha }}
        shell: bash
        run: |
          set -euo pipefail

          PRS_JSON="$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/commits/$HEAD_SHA/pulls")"

          DEPENDABOT_PR="$(jq -r '[.[] | select(.user.login == "dependabot[bot]" and .merged_at != null)] | first | .number // empty' <<<"$PRS_JSON")"

          if [ -z "$DEPENDABOT_PR" ]; then
            echo "is_dependabot=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "is_dependabot=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=$DEPENDABOT_PR" >> "$GITHUB_OUTPUT"

      - name: Check out main
        if: steps.gate.outputs.is_dependabot == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: main
          fetch-depth: 0

      - name: Set up JDK 21
        if: steps.gate.outputs.is_dependabot == 'true'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9
        with:
          java-version: 21
          distribution: temurin

      - name: Cache Maven packages
        if: steps.gate.outputs.is_dependabot == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Compute next patch version
        if: steps.gate.outputs.is_dependabot == 'true'
        id: version
        shell: bash
        run: |
          set -euo pipefail

          CURRENT_VERSION="$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)"
          export CURRENT_VERSION

          NEXT_VERSION="$(python3 - <<'PY'
          import os
          import re
          import sys

          current = os.environ["CURRENT_VERSION"].strip()
          match = re.search(r'(\d+)(?!.*\d)', current)
          if not match:
            print(f"Cannot increment version '{current}' because no numeric segment was found.", file=sys.stderr)
            sys.exit(1)

          next_version = current[:match.start(1)] + str(int(match.group(1)) + 1) + current[match.end(1):]
          print(next_version)
          PY
          )"

          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "next=$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set new Maven version
        if: steps.gate.outputs.is_dependabot == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mvn -B versions:set -DnewVersion="${{ steps.version.outputs.next }}" -DgenerateBackupPoms=false

      - name: Build jar for new version
        if: steps.gate.outputs.is_dependabot == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mvn -B -DskipTests package

      - name: Commit and push version bump
        if: steps.gate.outputs.is_dependabot == 'true'
        env:
          NEXT_VERSION: ${{ steps.version.outputs.next }}
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- pom.xml; then
            echo "No version change to commit."
            exit 0
          fi

          git add pom.xml
          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "chore(release): bump version to ${NEXT_VERSION} after Dependabot update"
          git push origin HEAD:main
